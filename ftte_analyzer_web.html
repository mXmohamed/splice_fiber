<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identification des positions FTTE par PM</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .upload-area:hover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }
        input[type="file"] {
            display: none;
        }
        .upload-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .upload-button:hover {
            background-color: #45a049;
        }
        .upload-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #analyzeButton {
            display: none;
            margin: 20px auto;
            background-color: #2196F3;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        #analyzeButton:hover {
            background-color: #1976D2;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        #status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            display: block;
        }
        #status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        #status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .results-container {
            display: none;
            margin-top: 30px;
        }
        .download-section {
            text-align: center;
            margin-bottom: 20px;
        }
        #downloadButton {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        #downloadButton:hover {
            background-color: #45a049;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-table th {
            background-color: #2196F3;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        .stats-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        .stats-table tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        .stats-table .value {
            text-align: right;
            font-weight: bold;
            color: #2196F3;
        }
        .loading-spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Identification des positions FTTE par PM</h1>
        
        <div class="upload-area" id="uploadArea">
            <p>üìÅ Glissez-d√©posez votre fichier ZIP ici</p>
            <p>ou</p>
            <label for="fileInput" class="upload-button" id="uploadLabel">S√©lectionner un fichier</label>
            <input type="file" id="fileInput" accept=".zip">
            <div class="file-info" id="fileInfo"></div>
        </div>

        <button id="analyzeButton" style="display: none;">ANALYSER</button>

        <div id="status"></div>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <div id="output"></div>

        <div class="results-container" id="resultsContainer">
            <div class="download-section">
                <button id="downloadButton">üì• T√©l√©charger les r√©sultats CSV</button>
            </div>
            
            <table class="stats-table">
                <tr>
                    <th colspan="2">üìä R√©sum√© de l'analyse</th>
                </tr>
                <tr>
                    <td>Nombre de cassettes FTTE</td>
                    <td class="value" id="statCassettes">-</td>
                </tr>
                <tr>
                    <td>Nombre de c√¢bles Transport (TR)</td>
                    <td class="value" id="statCablesTR">-</td>
                </tr>
                <tr>
                    <td>Nombre de c√¢bles Distribution (DI)</td>
                    <td class="value" id="statCablesDI">-</td>
                </tr>
                <tr>
                    <td>Nombre de SRO</td>
                    <td class="value" id="statSRO">-</td>
                </tr>
                <tr>
                    <td>Nombre de positions FTTE identifi√©es</td>
                    <td class="value" id="statPositions">-</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        let pyodide = null;
        let outputContent = '';
        let fileToAnalyze = null;
        
        // Charger Pyodide au chargement de la page
        async function loadPyodideAndPackages() {
            showStatus('Chargement de Python dans le navigateur...', 'loading');
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['micropip']);
                showStatus('Python charg√© avec succ√®s !', 'success');
                setTimeout(() => hideStatus(), 3000);
            } catch (error) {
                showStatus('Erreur lors du chargement de Python: ' + error, 'error');
            }
        }

        // Charger Pyodide d√®s le d√©but
        loadPyodideAndPackages();

        // Gestion du drag and drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadLabel = document.getElementById('uploadLabel');
        const analyzeButton = document.getElementById('analyzeButton');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                prepareFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                prepareFile(e.target.files[0]);
            }
        });

        analyzeButton.addEventListener('click', () => {
            if (fileToAnalyze) {
                handleFile(fileToAnalyze);
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.style.display = 'none';
        }

        function showOutput(text) {
            const output = document.getElementById('output');
            output.textContent = text;
            output.style.display = 'none';  // Cacher les logs
            outputContent = text;
        }

        function prepareFile(file) {
            if (!file.name.endsWith('.zip')) {
                showStatus('Veuillez s√©lectionner un fichier ZIP', 'error');
                return;
            }

            fileToAnalyze = file;
            document.getElementById('fileInfo').textContent = `Fichier: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            analyzeButton.style.display = 'block';
            hideStatus();
            document.getElementById('output').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'none';
        }

        async function handleFile(file) {
            if (!pyodide) {
                showStatus('Python est encore en cours de chargement, veuillez patienter...', 'loading');
                return;
            }

            uploadLabel.disabled = true;
            analyzeButton.style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'block';
            showStatus('Analyse en cours...', 'loading');

            try {
                // Lire le fichier comme ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // Passer le fichier √† Pyodide
                pyodide.FS.writeFile('input.zip', uint8Array);

                // Code Python modifi√© pour le web avec statistiques
                const pythonCode = `
import zipfile
import csv
import time
from datetime import datetime
import io
import sys

# Rediriger stdout pour capturer la sortie
output_buffer = io.StringIO()
sys.stdout = output_buffer

# Variables pour les statistiques
stats = {
    'cassettes_ftte': 0,
    'cables_tr': 0,
    'cables_di': 0,
    'sro': 0,
    'positions_ftte': 0
}

def process_ftte_analysis():
    print("D√©marrage de l'analyse du fichier...")
    start_time = time.time()
    
    try:
        with zipfile.ZipFile('input.zip', 'r') as zip_file:
            # V√©rifier les fichiers requis
            required_files = [
                't_cassette.csv',
                't_position.csv',
                't_fibre.csv',
                't_cable.csv',
                't_site.csv',
                't_local.csv'
            ]
            
            for file_name in required_files:
                if file_name not in zip_file.namelist():
                    print(f"‚ùå Erreur: Fichier manquant: {file_name}")
                    return None
            
            print("‚úÖ Tous les fichiers requis sont pr√©sents")
            
            # 1. Charger les cassettes FTTE
            print("\\nüìã Chargement des cassettes FTTE...")
            cassettes_ftte = set()
            with zip_file.open('t_cassette.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                row_count = 0
                for row in reader:
                    row_count += 1
                    clean_row = {k.strip().replace('\\ufeff', ''): v for k, v in row.items() if k}
                    if clean_row.get('cs_type') == 'E' and not clean_row.get('cs_bp_code', '').strip():
                        cassettes_ftte.add(clean_row.get('cs_code', ''))
                
                print(f"   ‚Üí {row_count} lignes trait√©es")
            
            stats['cassettes_ftte'] = len(cassettes_ftte)
            print(f"   ‚Üí {len(cassettes_ftte)} cassettes FTTE trouv√©es")
            
            # 2. Charger les c√¢bles
            print("\\nüîå Chargement des c√¢bles...")
            cables = {}
            cables_tr_count = 0
            cables_di_count = 0
            
            with zip_file.open('t_cable.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                pe_count = 0
                for row in reader:
                    clean_row = {k.strip().replace('\\ufeff', ''): v.strip() if v else '' 
                                for k, v in row.items() if k}
                    
                    cb_code = clean_row.get('cb_code')
                    cb_typelog = clean_row.get('cb_typelog')
                    cb_nd1 = clean_row.get('cb_nd1', '')
                    cb_nd2 = clean_row.get('cb_nd2', '')
                    
                    # Compter les types de c√¢bles
                    if cb_typelog == 'TR':
                        cables_tr_count += 1
                    elif cb_typelog == 'DI':
                        cables_di_count += 1
                    
                    pe_node = None
                    if cb_nd1.startswith('PE'):
                        pe_node = cb_nd1
                        pe_count += 1
                    elif cb_nd2.startswith('PE'):
                        pe_node = cb_nd2
                        pe_count += 1
                    
                    cables[cb_code] = {
                        'cb_typelog': cb_typelog,
                        'cb_etiquet': clean_row.get('cb_etiquet', cb_code),
                        'cb_nd1': cb_nd1,
                        'cb_nd2': cb_nd2,
                        'pe_node': pe_node
                    }
            
            stats['cables_tr'] = cables_tr_count
            stats['cables_di'] = cables_di_count
            print(f"   ‚Üí {len(cables)} c√¢bles charg√©s")
            print(f"   ‚Üí {cables_tr_count} c√¢bles TR, {cables_di_count} c√¢bles DI")
            print(f"   ‚Üí {pe_count} c√¢bles avec n≈ìud PE identifi√©")
            
            # 3. Cr√©er un index des fibres
            print("\\nüîç Cr√©ation de l'index des fibres...")
            fibre_to_cable = {}
            
            with zip_file.open('t_fibre.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                for row in reader:
                    clean_row = {k.strip().replace('\\ufeff', ''): v for k, v in row.items() if k}
                    fibre_code = clean_row.get('fo_code')
                    cable_code = clean_row.get('fo_cb_code')
                    if cable_code in cables:
                        fibre_to_cable[fibre_code] = cable_code
            
            print(f"   ‚Üí {len(fibre_to_cable)} fibres index√©es")
            
            # 4. Charger les sites
            print("\\nüè¢ Chargement des sites...")
            noeud_to_site = {}
            with zip_file.open('t_site.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                pe_sites = 0
                for row in reader:
                    clean_row = {k.strip().replace('\\ufeff', ''): v.strip() if v else '' 
                                for k, v in row.items() if k}
                    nd_code = clean_row.get('st_nd_code')
                    st_code = clean_row.get('st_code')
                    if nd_code and st_code:
                        noeud_to_site[nd_code] = st_code
                        if nd_code.startswith('PE'):
                            pe_sites += 1
            
            print(f"   ‚Üí {len(noeud_to_site)} relations n≈ìud->site charg√©es")
            print(f"   ‚Üí dont {pe_sites} n≈ìuds PE")
            
            # 5. Charger les locaux SRO
            print("\\nüè¢ Chargement des locaux SRO...")
            site_to_local = {}
            sro_count = 0
            
            with zip_file.open('t_local.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                for row in reader:
                    clean_row = {k.strip().replace('\\ufeff', ''): v.strip() if v else '' 
                                for k, v in row.items() if k}
                    if clean_row.get('lc_typelog') == 'SRO':
                        sro_count += 1
                        st_code = clean_row.get('lc_st_code')
                        if st_code:
                            site_to_local[st_code] = {
                                'lc_code': clean_row.get('lc_code'),
                                'lc_etiquet': clean_row.get('lc_etiquet')
                            }
            
            stats['sro'] = sro_count
            print(f"   ‚Üí {len(site_to_local)} locaux SRO charg√©s (total SRO: {sro_count})")
            
            # 6. Traiter les positions
            print("\\n‚öôÔ∏è Traitement des positions...")
            results = []
            positions_processed = 0
            no_pe_count = 0
            no_site_count = 0
            no_local_count = 0
            
            with zip_file.open('t_position.csv') as f:
                content = f.read()
                for encoding in ['utf-8', 'latin-1', 'cp1252']:
                    try:
                        decoded = content.decode(encoding)
                        break
                    except:
                        continue
                
                lines = decoded.splitlines()
                delimiter = ';' if ';' in lines[0] else ','
                reader = csv.DictReader(lines, delimiter=delimiter)
                
                for row in reader:
                    positions_processed += 1
                    clean_row = {k.strip().replace('\\ufeff', ''): v for k, v in row.items() if k}
                    
                    if clean_row.get('ps_cs_code') not in cassettes_ftte:
                        continue
                    
                    fibre1 = clean_row.get('ps_1')
                    fibre2 = clean_row.get('ps_2')
                    
                    if fibre1 not in fibre_to_cable or fibre2 not in fibre_to_cable:
                        continue
                    
                    cable1_code = fibre_to_cable[fibre1]
                    cable2_code = fibre_to_cable[fibre2]
                    cable1 = cables[cable1_code]
                    cable2 = cables[cable2_code]
                    
                    if cable1['cb_typelog'] == 'TR' and cable2['cb_typelog'] == 'DI':
                        cable_tr = cable1
                        cable_di = cable2
                        fibre_tr = fibre1
                        fibre_di = fibre2
                    elif cable1['cb_typelog'] == 'DI' and cable2['cb_typelog'] == 'TR':
                        cable_tr = cable2
                        cable_di = cable1
                        fibre_tr = fibre2
                        fibre_di = fibre1
                    else:
                        continue
                    
                    pe_node = cable_di.get('pe_node')
                    if not pe_node:
                        no_pe_count += 1
                        continue
                    
                    site_code = noeud_to_site.get(pe_node)
                    if not site_code:
                        no_site_count += 1
                        continue
                    
                    local_info = site_to_local.get(site_code)
                    if not local_info:
                        no_local_count += 1
                        continue
                    
                    results.append({
                        'Cassette FTTE': clean_row['ps_cs_code'],
                        'Fibre Transport': fibre_tr,
                        'Cable Transport': cable_tr['cb_etiquet'],
                        'Fibre Distribution': fibre_di,
                        'Cable Distribution': cable_di['cb_etiquet'],
                        'Noeud PE': pe_node,
                        'Site': site_code,
                        'Local PM': local_info['lc_code'],
                        'Etiquette PM': local_info['lc_etiquet']
                    })
                    
                    if positions_processed % 100000 == 0:
                        print(f"   ‚Üí {positions_processed:,} positions trait√©es, {len(results):,} r√©sultats trouv√©s...")
            
            stats['positions_ftte'] = len(results)
            
            elapsed_time = time.time() - start_time
            print(f"\\n‚úÖ Analyse termin√©e en {elapsed_time:.2f} secondes")
            print(f"\\nüìä R√©sultats:")
            print(f"   - Positions trait√©es: {positions_processed:,}")
            print(f"   - Connexions FTTE trouv√©es: {len(results):,}")
            print(f"   - Rejets - Pas de n≈ìud PE: {no_pe_count:,}")
            print(f"   - Rejets - Site non trouv√©: {no_site_count:,}")
            print(f"   - Rejets - Local non trouv√©: {no_local_count:,}")
            
            return results
            
    except Exception as e:
        print(f"\\n‚ùå Erreur lors du traitement: {str(e)}")
        import traceback
        traceback.print_exc()
        return None

# Ex√©cuter l'analyse
results = process_ftte_analysis()

# Cr√©er le CSV si des r√©sultats existent
csv_content = None
if results:
    output = io.StringIO()
    fieldnames = [
        'Cassette FTTE', 'Fibre Transport', 'Cable Transport',
        'Fibre Distribution', 'Cable Distribution', 
        'Noeud PE', 'Site', 'Local PM', 'Etiquette PM'
    ]
    writer = csv.DictWriter(output, fieldnames=fieldnames, delimiter=';')
    writer.writeheader()
    for row in results:
        writer.writerow(row)
    csv_content = output.getvalue()

# Retourner la sortie, le CSV et les statistiques sous forme de liste
(output_buffer.getvalue(), csv_content, [
    stats['cassettes_ftte'],
    stats['cables_tr'],
    stats['cables_di'],
    stats['sro'],
    stats['positions_ftte']
])
`;

                // Ex√©cuter le code Python
                const [output, csvContent, statistics] = await pyodide.runPythonAsync(pythonCode);
                
                showOutput(output);
                
                if (csvContent) {
                    showStatus('Analyse termin√©e avec succ√®s !', 'success');
                    
                    // Mettre √† jour les statistiques depuis le tableau
                    document.getElementById('statCassettes').textContent = Number(statistics[0]).toLocaleString('fr-FR');
                    document.getElementById('statCablesTR').textContent = Number(statistics[1]).toLocaleString('fr-FR');
                    document.getElementById('statCablesDI').textContent = Number(statistics[2]).toLocaleString('fr-FR');
                    document.getElementById('statSRO').textContent = Number(statistics[3]).toLocaleString('fr-FR');
                    document.getElementById('statPositions').textContent = Number(statistics[4]).toLocaleString('fr-FR');
                    
                    // Afficher les r√©sultats
                    document.getElementById('resultsContainer').style.display = 'block';
                    
                    // Configurer le t√©l√©chargement
                    const downloadButton = document.getElementById('downloadButton');
                    downloadButton.onclick = () => {
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `ftte_results_${new Date().toISOString().slice(0,19).replace(/:/g,'').replace('T','_')}.csv`;
                        link.click();
                    };
                } else {
                    showStatus('Analyse termin√©e mais aucun r√©sultat trouv√©', 'error');
                }
                
            } catch (error) {
                showStatus('Erreur: ' + error.message, 'error');
                showOutput(outputContent + '\\n\\nErreur: ' + error.toString());
            } finally {
                uploadLabel.disabled = false;
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }
    </script>
</body>
</html>